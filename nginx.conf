#TODO: Rivedere e testare
events {}

http {
    # Configurazione per il rate-limiting
    limit_req_zone $binary_remote_addr zone=req_limit_per_ip:10m rate=5r/s;  # 5 richieste per secondo per IP

    # Log di accesso e di errore
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # Configurazione per la gestione della validit√† del token JWT
    set $jwt_secret "your_secret_key";  # Chiave segreta JWT

    server {
        listen 80;

        # Game Catalog Service
        location /game-catalog/ {
            limit_req zone=req_limit_per_ip burst=10;  # Consente un burst di 10 richieste
            # Autenticazione JWT (TODO: assicurarsi che il modulo ngx_http_auth_jwt_module sia disponibile)
            auth_jwt "Restricted Area" token=$http_authorization;
            auth_jwt_key_file /etc/nginx/keys/jwt_secret.key;  # La chiave segreta JWT

            proxy_pass http://game-catalog:3001;  # Indirizza verso il servizio game-catalog
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # Order Service
        location /order-service/ {
            limit_req zone=req_limit_per_ip burst=10;  # Consente un burst di 10 richieste
            auth_jwt "Restricted Area" token=$http_authorization;
            auth_jwt_key_file /etc/nginx/keys/jwt_secret.key;

            proxy_pass http://order-service:3002;  # Indirizza verso il servizio order-service
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # Notification Service
        location /notification-service/ {
            limit_req zone=req_limit_per_ip burst=10;  # Consente un burst di 10 richieste
            auth_jwt "Restricted Area" token=$http_authorization;
            auth_jwt_key_file /etc/nginx/keys/jwt_secret.key;

            proxy_pass http://notification-service:3003;  # Indirizza verso il servizio notification-service
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # Configurazione del monitoraggio delle statistiche di NGINX
        location /nginx_status {
            stub_status on;  # Mostra statistiche di stato
            access_log off;
            allow 127.0.0.1;  # Consente solo richieste locali
            deny all;  # Nega tutte le altre richieste
        }
    }
}
